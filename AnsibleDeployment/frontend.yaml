- name: Install node packages
  package:
    name:
      - nodejs
      - npm
    state: present

- name: Install yarn
  command: |
    npm install yarn

- name: Set PATH
  lineinfile:
    dest: /etc/environment
    state: present
    line: 'PATH=/home/ubuntu/node_modules/yarn/bin:${PATH}'

- name: Clone the project repository
  git:
    repo: https://github.com/docker/getting-started.git
    dest: /home/ubuntu
    clone: yes

- name: install dependencies
  become_user: ubuntu
  command: yarn install --production
  args:
    chdir: $HOME/getting-started/app/

- name: run application
  become_user: ubuntu
  command: node src/index.js
  args:
    chdir: $HOME/getting-started/app/
  environment:
    MYSQL_HOST: "{{ mysql_host }}"
    MYSQL_USER: "{{ mysql_user }}"
    MYSQL_PASSWORD: "{{ mysql_pass }}"
    MYSQL_DB: "{{ mysql_db }}"
