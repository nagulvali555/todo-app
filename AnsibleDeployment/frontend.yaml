- name: setting variables
  set_fact:
    node_modules_dir: /usr/local

- name: Install node packages
  package:
    name:
      - nodejs
      - npm
    state: present

- name: Install yarn
  npm:
    name: yarn
    path: '{{ node_modules_dir }}'
    state: present

- name: Clone the project repository
  git:
    repo: https://github.com/docker/getting-started.git
    dest: ~/getting-started
    clone: yes

- name: install dependencies
  command: yarn install --production
  args:
    chdir: ~/getting-started/app/
  environment:
    PATH: "{{ node_modules_dir }}:{{ ansible_env.PATH }}"

- name: run application
  command: node src/index.js
  args:
    chdir: ~/getting-started/app/
  environment:
    MYSQL_HOST: "{{ mysql_host }}"
    MYSQL_USER: "{{ mysql_user }}"
    MYSQL_PASSWORD: "{{ mysql_pass }}"
    MYSQL_DB: "{{ mysql_db }}"
