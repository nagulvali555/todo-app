- name: set variables
  set_fact:
    node_module_dir: /usr/local

- name: Install node packages
  package:
    name:
      - nodejs
      - npm
    state: present

- name: Install yarn
  npm:
    name: yarn
    path: '{{ node_module_dir }}'
    state: present

- name: Clone the project repository
  git:
    repo: https://github.com/docker/getting-started.git
    dest: ~/getting-started
    clone: yes

- name: check dependencies
  stat:
    path: ~/.yarn_dependencies
  register: yarn_dependencies

- name: install dependencies
  command: '{{ item }}'
  args:
    chdir: ~/getting-started/app/
  loop:
    - '{{ node_module_dir }}/node_modules/yarn/bin/yarn install --production'
    - touch ~/.yarn_dependencies
  when: not yarn_dependencies.stat.exists

- name: run application
  command: nohup node src/index.js >> app.log 2>&1 &
  args:
    chdir: ~/getting-started/app/
